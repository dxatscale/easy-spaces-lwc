name: Fetch and Release

stages:
    - stage: release
      displayName: release
      jobs:
          - job: release
            displayName: release
            pool:
                vmImage: 'ubuntu-latest'
            container: dxatscale/sfpowerscripts:latest
            steps:
                - checkout: self

                - task: DownloadSecureFile@1
                  name: npmrc
                  inputs:
                      secureFile: .npmrc

                - task: DownloadSecureFile@1
                  name: devhubKey
                  inputs:
                      secureFile: 'DEVHUB_SERVER_KEY'

                - script: |
                      sfdx sfpowerscripts:artifacts:fetch -p .azure-pipelines/releaseDefinitions/releaseDefinition.yml --npm --scope dxatscale --npmrcpath $(npmrc.secureFilePath)
                  displayName: 'Fetch artifacts from NPM registry'

                - script: |
                      sfdx auth:jwt:grant -u $(DEVHUB_USERNAME) -i $(DEVHUB_CLIENT_ID) -f $(devhubKey.secureFilePath) -a devhub -r https://login.salesforce.com
                  displayName: 'Authenticate DevHub'

                - task: CmdLine@2
                  displayName: 'Create ScratchOrg'
                  inputs:
                      script: 'sfdx force:org:create -f config/project-scratch-def.json -a scratch-org -s -d 1 -v devhub'

                - task: CmdLine@2
                  displayName: 'Deploy packages to scratch org'
                  inputs:
                      script: 'sfdx sfpowerscripts:orchestrator:deploy -u scratch-org'

                - task: CmdLine@2
                  displayName: 'Delete scratch org'
                  condition: always()
                  inputs:
                      script: 'sfdx force:org:delete -p -u scratch-org'
